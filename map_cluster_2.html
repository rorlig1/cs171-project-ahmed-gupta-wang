<!DOCTYPE html>
<html>
<head>
	<title>Leaflet debug page</title>

	<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7/leaflet.css" />
	<script src="http://cdn.leafletjs.com/leaflet-0.7/leaflet.js"></script>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="css/screen.css" />

	<link rel="stylesheet" href="css/MarkerCluster.css" />
	<link rel="stylesheet" href="css/MarkerCluster.Default.css" />
	<script src="js/leaflet.markercluster-src.js"></script>
	<script type="text/javascript" src="data_with_open/phoenix_geo.js"></script>
	<script type="text/javascript" src="js/underscore.js"></script>
	<script src="js/d3.js"></script>


	<style>
/*
 * Unlike other icons, you can style `L.divIcon` instances with CSS.
 * These styles make each marker a circle with a border and centered
 * text
 */
.count-icon {
    background:#fee;
    text-align:center;
    vertical-align:middle;
    border:1px solid #000;
    border-radius:20px;
    line-height:30px;
}
</style>


</head>
<body>

	<div id="map"></div>
	<script type="text/javascript">
	//tile of the map....
	var tiles = L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
			maxZoom: 18,
			attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
		}),
		latlng = L.latLng( 33.4, - 112.02 );

	//main map object
	var map = L.map('map', {center: latlng, zoom: 9, layers: [tiles]});

	var pins = [];

	//customIcon for the map
	var custIcon = L.divIcon({
	            // specify a class name that we can refer to in styles, as we
	            // do above.
	            className: 'count-icon',
	            // html here defines what goes in the div created for each marker
	            html: "40",
	            // and the marker width and height
	            iconSize: [20, 20]
      		})


	function createClusters (clusters) {
		var geojson = L.geoJson(clusters, {
			 pointToLayer: function (feature, latlng) {
			 	console.log(latlng);
         		return L.marker(latlng).bindLabel( feature.properties.name, { noHide: true });
    		},

			onEachFeature: function (feature, layer) {
				console.log('clicked');
				var popupText = 'county:  ' + feature.properties.name;
				layer.bindPopup(popupText);
			}
		})

		map.addLayer(geojson);

		addMarkerLabels(clusters);

		console.log(pins);

		_.each(pins, function(pin){
			pin.addTo(map);
		})		


		// body...
	}

	function addMarkerLabels(clusters){
		_.each(clusters.features, function(row){
			console.log(row.properties.count)
			var markerLabel;
			if (row.properties.count==undefined){
				markerLabel = 0;
			} else {
				markerLabel = row.properties.count;
			}
			custIcon.html = row.properties.count!==undefined? row.properties.count: 0;
			console.log(row.properties.name + " lat:"  + row.g.location.lat + " lng:" + row.g.location.lng);
			var latlng = new L.LatLng(row.g.centroid[1],  row.g.centroid[0]);
			var icon  = L.divIcon({
	            // specify a class name that we can refer to in styles, as we
	            // do above.
	            className: 'count-icon',
	            // html here defines what goes in the div created for each marker
	            html: "" + markerLabel,
	            // and the marker width and height
	            iconSize: [30, 30]
        	})

			pins.push(new L.Marker(latlng, {icon: icon}));
		})

	}
		
		// var geojson = L.geoJson(geojsonSample, {

		// 	// style: function (feature) {
		// 	// 	return {color: #e3e3e3};
		// 	// },

		// 	 pointToLayer: function (feature, latlng) {
		// 	 	console.log(latlng);
  //        		return L.marker(latlng).bindLabel( feature.properties.name, { noHide: true });
  //   		},

		// 	onEachFeature: function (feature, layer) {
		// 		console.log('clicked');
		// 		var popupText = 'county:  ' + feature.properties.name;
		// 		layer.bindPopup(popupText);
		// 	},

			
		// })

		
		// map.addLayer(geojson)

		// .on("click", function(feature){ console.log('clicked' + feature.properties.cartodb_id)})
		// var pins = []
		// _.each(geojsonSample.features, function(row){
		// 	console.log(row.properties.count)
		// 	var markerLabel;
		// 	if (row.properties.count==undefined){
		// 		markerLabel = 0;
		// 	} else {
		// 		markerLabel = row.properties.count;
		// 	}
		// 	custIcon.html = row.properties.count!==undefined? row.properties.count: 0;
		// 	console.log(row.properties.name + " lat:"  + row.g.location.lat + " lng:" + row.g.location.lng);
		// 	var latlng = new L.LatLng(row.g.centroid[1],  row.g.centroid[0]);
		// 	var icon  = L.divIcon({
	 //            // specify a class name that we can refer to in styles, as we
	 //            // do above.
	 //            className: 'count-icon',
	 //            // html here defines what goes in the div created for each marker
	 //            html: "" + markerLabel,
	 //            // and the marker width and height
	 //            iconSize: [40, 40]
  //       	})

		// 	new L.Marker(latlng, {icon: icon}).addTo(map);
		// })

		//set the max and minimum zoom levels 
		map._layersMaxZoom=11 
		map._layersMinZoom = 9

		//load the clusters... 
		d3.json('data_with_open/phoenix_geo.json', function(err, clusters){
			//load the other stuff...
			d3.json('data_with_open/output_phoenix_all.json', function (error, data) {
				// populate(data);
				// map.addLayer(markers);
				createClusters(clusters);

			})

		})
		
	

	</script>
</body>
</html>
